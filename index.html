<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>India Post | Dak Sewa Dashboard</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            /* Official India Post Colors */
            --ip-red: #CE2029;       
            --ip-dark-red: #A3121A;  
            --ip-yellow: #FDB813;    
            --ip-bg: #FFFBF5;        
            --ip-text: #212121;
            --white: #FFFFFF;
            --border-color: #E0E0E0;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Open Sans', sans-serif; background: var(--ip-bg); color: var(--ip-text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* --- 1. GOVT TOP STRIP --- */
        .gov-strip {
            height: 34px; background: #F1F1F1; border-bottom: 1px solid #CCC; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; font-size: 12px; color: #333; flex-shrink: 0;
        }
        .gov-left { display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .gov-right span { margin-left: 15px; cursor: pointer; color: #555; }
        .gov-right span:hover { color: var(--ip-red); }
        .lang-switch { border: 1px solid #999; padding: 1px 5px; border-radius: 3px; }

        /* --- 2. BRANDING HEADER --- */
        .brand-header {
            height: 90px; background: var(--white); display: flex; align-items: center; justify-content: space-between; padding: 0 40px; border-bottom: 4px solid var(--ip-yellow); flex-shrink: 0;
        }
        .brand-logos { display: flex; align-items: center; gap: 20px; }
        
        /* Updated Logo Class */
        .main-logo { height: 60px; width: auto; object-fit: contain; } 
        
        .dept-text h1 { font-family: 'Roboto', sans-serif; font-size: 22px; font-weight: 700; color: #000; margin: 0; line-height: 1.2; }
        .dept-text p { font-size: 12px; font-weight: 600; color: #555; margin: 0; text-transform: uppercase; }
        
        .header-tools { display: flex; align-items: center; gap: 20px; }
        .search-box { display: flex; border: 1px solid #CCC; border-radius: 4px; overflow: hidden; }
        .search-box input { border: none; padding: 8px; font-size: 13px; width: 200px; outline: none; }
        .search-box button { background: white; border: none; color: #555; padding: 0 10px; cursor: pointer; }
        .swachh-logo { height: 45px; }

        /* --- MAIN LAYOUT --- */
        .app-container { display: flex; flex: 1; overflow: hidden; }

        /* --- 3. SIDEBAR --- */
        .sidebar {
            width: 260px; background: var(--white); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 100;
        }
        
        .sidebar-header {
            background: var(--ip-red); color: white; padding: 15px 20px; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 10px;
            clip-path: polygon(0 0, 100% 0, 95% 50%, 100% 100%, 0 100%);
            margin-right: -10px; padding-right: 30px; 
        }

        .nav-menu { padding: 10px; flex: 1; }
        .nav-item {
            display: flex; align-items: center; padding: 12px 15px; margin-bottom: 5px; color: #333;
            border: 1px solid #EEE; border-radius: 4px; cursor: pointer; transition: 0.2s; font-size: 14px; font-weight: 600;
        }
        .nav-item:hover { background: #F9F9F9; color: var(--ip-red); border-color: var(--ip-red); }
        .nav-item.active { background: var(--ip-red); color: white; border-color: var(--ip-red); }
        .nav-item i { width: 25px; font-size: 16px; }

        .live-feed-widget {
            background: #FFF; border-top: 4px solid var(--ip-red); padding: 0; display: flex; flex-direction: column; height: 280px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .feed-title {
            padding: 10px 15px; font-size: 14px; font-weight: 700; color: var(--ip-red); border-bottom: 1px solid #EEE; display: flex; align-items: center; gap: 8px;
        }
        .sidebar-list { overflow-y: auto; flex: 1; }
        .yt-row {
            padding: 10px 15px; border-bottom: 1px solid #F0F0F0; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s;
        }
        .yt-row:hover { background: #FFF5F5; }
        .priority-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

        /* --- 4. MAIN WORKSPACE --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background-image: linear-gradient(#FFFBF5 0%, #F5F5F5 100%); }

        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .dash-title h2 { font-size: 24px; color: var(--ip-red); margin: 0; font-weight: 700; font-family: 'Roboto', sans-serif; }
        .dash-title span { font-size: 13px; color: #666; }
        .admin-badge { background: var(--ip-red); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 8px; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; max-width: 1600px; margin: 0 auto; }
        
        .card {
            background: white; border: 1px solid #EAEAEA; border-radius: 8px; padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; position: relative;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: var(--ip-red); }
        .card-header { font-size: 15px; font-weight: 700; color: #333; margin-bottom: 15px; border-bottom: 2px solid var(--ip-yellow); padding-bottom: 8px; display: inline-block; }

        .kpi-card { height: 130px; justify-content: center; background: white; border-top: 3px solid transparent; }
        .kpi-card:hover { border-top-color: var(--ip-red); }
        .kpi-title { font-size: 12px; font-weight: 600; color: #777; text-transform: uppercase; }
        .kpi-val { font-size: 32px; font-weight: 700; color: #222; margin: 5px 0; font-family: 'Roboto', sans-serif; }
        .kpi-icon { position: absolute; right: 20px; top: 20px; font-size: 30px; opacity: 0.1; color: var(--ip-red); }

        .card-pending { border: 1px solid #FFCDD2; background: #FFEBEE; cursor: pointer; }
        .card-pending .kpi-val { color: var(--ip-red); }
        .pulse-text { animation: pulse-text 1.5s infinite; color: var(--ip-red); font-weight: bold; font-size: 11px; }

        /* AI Input */
        .ai-section { grid-column: span 1; grid-row: span 2; }
        .ai-wrapper { border: 1px solid #DDD; background: #FAFAFA; padding: 10px; border-radius: 4px; flex: 1; display: flex; flex-direction: column; }
        .ai-textarea { width: 100%; border: none; background: transparent; resize: none; font-family: inherit; font-size: 13px; flex: 1; }
        .mic-btn { width: 36px; height: 36px; background: var(--ip-red); color: white; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .mic-btn.active { animation: pulse-shadow 1s infinite; background: #B71C1C; }
        .btn-analyze { background: #333; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: 600; font-size: 12px; cursor: pointer; }

        .analytics-section { grid-column: span 3; grid-row: span 2; height: 420px; }
        .feed-section { grid-column: span 4; }

        .gov-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .gov-table th { background: #F5F5F5; text-align: left; padding: 12px; font-weight: 700; color: #444; border-bottom: 2px solid #DDD; }
        .gov-table td { padding: 12px; border-bottom: 1px solid #EEE; color: #333; }
        .badge { padding: 3px 8px; border-radius: 3px; font-size: 11px; font-weight: 600; }
        .bg-red { background: #FFEBEE; color: #C62828; border: 1px solid #FFCDD2; }
        .bg-green { background: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        
        .modal-box { background: white; width: 900px; border-radius: 8px; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.2); transform: scale(0.95); transition: 0.3s; overflow: hidden; }
        .modal-overlay.open .modal-box { transform: scale(1); }
        
        .modal-header { background: var(--ip-red); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 16px; }
        .close-btn { color: white; font-size: 24px; cursor: pointer; }
        
        .modal-body { padding: 25px; }
        .stat-row { display: flex; gap: 15px; margin-bottom: 25px; }
        .stat-item { flex: 1; background: #FFF9F0; border: 1px solid #F0E0C0; padding: 15px; text-align: center; border-radius: 6px; }
        .stat-item h3 { font-size: 20px; color: var(--ip-red); margin: 0 0 5px 0; font-weight: 700; }
        .stat-item p { font-size: 11px; color: #666; margin: 0; text-transform: uppercase; font-weight: 600; }

        /* Animations */
        @keyframes pulse-text { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes pulse-shadow { 0% { box-shadow: 0 0 0 0 rgba(206, 32, 41, 0.4); } 100% { box-shadow: 0 0 0 10px rgba(0,0,0,0); } }
        .app-view { display: none; } .app-view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Analytics Grid */
        .analytics-grid { display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 20px; }
        .grid-kpi-row { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .a-col-1 { grid-column: 1 / 2; grid-row: 2 / 4; }
        .a-col-2-top { grid-column: 2 / 3; grid-row: 2 / 3; }
        .a-col-2-btm { grid-column: 2 / 3; grid-row: 3 / 4; }
        .a-col-3-top { grid-column: 3 / 4; grid-row: 2 / 3; }
        .a-col-3-btm { grid-column: 3 / 4; grid-row: 3 / 4; }
    </style>
</head>
<body>

    <div class="gov-strip">
        <div class="gov-left">
            <img src="https://upload.wikimedia.org/wikipedia/en/thumb/4/41/Flag_of_India.svg/20px-Flag_of_India.svg.png" style="height:12px; margin-right:5px;">
            GOVERNMENT OF INDIA
        </div>
        <div class="gov-right">
            <span>Skip to Main Content</span>
            <span><i class="fas fa-sitemap"></i></span>
            <span><i class="fas fa-wheelchair"></i></span>
            <span class="lang-switch">A+</span>
            <span class="lang-switch">A-</span>
            <span class="lang-switch">हिंदी</span>
        </div>
    </div>

    <div class="brand-header">
        <div class="brand-logos">
            <img src="https://upload.wikimedia.org/wikipedia/en/thumb/3/32/India_Post.svg/1280px-India_Post.svg.png" class="main-logo">
            
            <div class="dept-text">
                <h1>Department of Posts</h1>
                <p>Ministry of Communications</p>
            </div>
        </div>
        <div class="header-tools">
            <div class="search-box">
                <input type="text" placeholder="Search data...">
                <button><i class="fas fa-search"></i></button>
            </div>
            <img src="https://upload.wikimedia.org/wikipedia/en/thumb/9/95/Swachh_Bharat_Mission_Logo.svg/1200px-Swachh_Bharat_Mission_Logo.svg.png" class="swachh-logo">
        </div>
    </div>

    <div class="app-container">
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-tachometer-alt"></i> Command Center
            </div>

            <div class="nav-menu">
                <div class="nav-item active" onclick="switchView('dashboard')"><i class="fas fa-th-large"></i> Dashboard Overview</div>
                <div class="nav-item" onclick="switchView('analytics')"><i class="fas fa-chart-line"></i> Analytics & Reports</div>
                <div class="nav-item" onclick="openPendingModal()"><i class="fas fa-exclamation-triangle" style="color:#CE2029"></i> Pending Actions</div>
                <div class="nav-item" onclick="switchView('complaints')"><i class="fas fa-list-ul"></i> Grievance Database</div>
                <div class="nav-item" onclick="switchView('config')"><i class="fas fa-tools"></i> System Tools</div>
            </div>

            <div class="live-feed-widget">
                <div class="feed-title"><i class="fas fa-bell"></i> Live Updates</div>
                <div class="sidebar-list" id="sidebar-list"></div>
            </div>
        </aside>

        <main class="main-content">
            <div class="dashboard-header">
                <div class="dash-title">
                    <h2 id="page-heading">Dashboard Overview</h2>
                    <span><i class="fas fa-clock"></i> Real-time Data Sync | Last Update: Just Now</span>
                </div>
                <div class="admin-badge">
                    <i class="fas fa-user-shield"></i> Admin Panel
                </div>
            </div>

            <div id="view-dashboard" class="app-view active">
                <div class="dashboard-grid">
                    
                    <div class="card kpi-card">
                        <div class="kpi-title">Total Complaints</div>
                        <div class="kpi-val" id="kpi-total">...</div>
                        <div class="kpi-sub" style="color:green"><i class="fas fa-arrow-up"></i> Live Inflow</div>
                        <i class="fas fa-envelope kpi-icon"></i>
                    </div>

                    <div class="card kpi-card">
                        <div class="kpi-title">AI Resolved</div>
                        <div class="kpi-val" id="kpi-resolved">...</div>
                        <div class="kpi-sub">Auto-closed by Bot</div>
                        <i class="fas fa-robot kpi-icon"></i>
                    </div>

                    <div class="card kpi-card card-pending" onclick="openPendingModal()">
                        <div class="kpi-title" style="color:var(--ip-red)">Pending Action</div>
                        <div class="kpi-val" id="kpi-pending">...</div>
                        <div class="kpi-sub"><span class="pulse-text">REQUIRES ATTENTION</span></div>
                        <i class="fas fa-exclamation-circle kpi-icon" style="opacity:0.2"></i>
                    </div>

                    <div class="card kpi-card">
                        <div class="kpi-title">Avg Response</div>
                        <div class="kpi-val">2.4<small>h</small></div>
                        <div class="kpi-sub" style="color:green">Within SLA</div>
                        <i class="fas fa-stopwatch kpi-icon"></i>
                    </div>

                    <div class="card ai-section">
                        <div class="card-header"><i class="fas fa-headset"></i> Assistant</div>
                        <p style="font-size:12px; color:#666; margin-bottom:10px;">"Namaste. Speak or type complaint details below."</p>
                        <div class="ai-wrapper">
                            <textarea id="manual-text" class="ai-textarea" placeholder="Enter details here..."></textarea>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-top:10px;">
                            <button class="mic-btn" id="mic-trigger"><i class="fas fa-microphone"></i></button>
                            <button class="btn-analyze" onclick="analyzeAndAdd()">LOG TICKET</button>
                        </div>
                        <div id="ai-output" style="margin-top:10px; font-size:12px; font-weight:700; color:var(--ip-red); display:none;"></div>
                    </div>

                    <div class="card analytics-section">
                        <div class="card-header">Complaint Categories</div>
                        <div style="height:100%"><canvas id="dashboardChart"></canvas></div>
                    </div>

                    <div class="card feed-section">
                        <div class="card-header">Recent Logs</div>
                        <table class="gov-table">
                            <thead><tr><th>ID</th><th>Summary</th><th>Type</th><th>Priority</th></tr></thead>
                            <tbody id="dashboard-table-body"></tbody>
                        </table>
                    </div>

                </div>
            </div>

            <div id="view-analytics" class="app-view">
                <div class="analytics-grid">
                    <div class="grid-kpi-row">
                        <div class="card kpi-card"><div><span class="kpi-title">TOTAL</span><div class="kpi-val">24,500</div></div></div>
                        <div class="card kpi-card"><div><span class="kpi-title">SOLVED</span><div class="kpi-val" style="color:green">15,200</div></div></div>
                        <div class="card kpi-card card-pending" onclick="openPendingModal()"><div><span class="kpi-title" style="color:var(--ip-red)">PENDING</span><div class="kpi-val">8,100</div></div></div>
                        <div class="card kpi-card"><div><span class="kpi-title">SPAM</span><div class="kpi-val" style="color:gray">1,200</div></div></div>
                    </div>
                    <div class="card a-col-1"><div class="card-header">Sentiment Analysis</div><div style="height:350px"><canvas id="stackedBarChart"></canvas></div></div>
                    <div class="card a-col-2-top"><div class="card-header" style="color:var(--ip-red)">Critical Alerts</div><div style="background:#FFF5F5; padding:10px; border-left:3px solid red; margin-bottom:5px;"><strong>#IP-9928</strong><br><small>Medicine Delayed</small></div></div>
                    <div class="card a-col-2-btm"><div class="card-header">Sentiment Ratio</div><div style="height:150px; display:flex; justify-content:center;"><canvas id="donutChart"></canvas></div></div>
                    <div class="card a-col-3-top"><div class="card-header">Hotspots</div><div id="india-map" style="height:100%; border-radius:4px;"></div></div>
                    <div class="card a-col-3-btm"><div class="card-header">Trend</div><canvas id="trendChart"></canvas></div>
                </div>
            </div>

            <div id="view-complaints" class="app-view">
                <div class="card">
                    <div class="card-header">Master Database</div>
                    <table class="gov-table"><thead><tr><th>ID</th><th>Customer</th><th>Complaint</th><th>Category</th><th>Status</th></tr></thead><tbody id="full-table-body"></tbody></table>
                </div>
            </div>

            <div id="view-config" class="app-view"><div class="card"><h3>System Configuration</h3></div></div>

        </div>
    </main>

    <div id="pendingModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span><i class="fas fa-chart-bar"></i> Pending Actions Report</span>
                <span class="close-btn" onclick="closePendingModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="stat-row">
                    <div class="stat-item"><h3>412</h3><p>Damaged/Lost</p></div>
                    <div class="stat-item"><h3>1,205</h3><p>Delays</p></div>
                    <div class="stat-item"><h3>320</h3><p>Financial</p></div>
                    <div class="stat-item"><h3>89</h3><p>Fake</p></div>
                    <div class="stat-item"><h3>540</h3><p>General</p></div>
                </div>
                <div style="height:350px; width:100%;"><canvas id="pendingBarChart"></canvas></div>
            </div>
        </div>
    </div>

    <div id="ticketModal" class="modal-overlay">
        <div class="modal-box" style="width: 600px;">
            <div class="modal-header">
                <span><i class="fas fa-ticket-alt"></i> Ticket Details</span>
                <span class="close-btn" onclick="closeTicketModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; font-size:14px;">
                    <div><strong>Ticket ID:</strong> <div id="tm-id" style="color:var(--ip-red); font-weight:bold; font-size:16px;"></div></div>
                    <div><strong>Priority:</strong> <div id="tm-prio"></div></div>
                    <div><strong>Category:</strong> <div id="tm-cat"></div></div>
                    <div><strong>Sentiment:</strong> <div id="tm-sent"></div></div>
                    <div style="grid-column: span 2;">
                        <strong>Complaint Description:</strong>
                        <div id="tm-msg" style="background:#F9F9F9; padding:10px; border:1px solid #EEE; margin-top:5px; height:100px; overflow-y:auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:5000/api";
        let dashboardChart, stackedBarChart, donutChart, trendChart, pendingBarChart;

        const mockTickets = [
            {ID:"IP-1001", Complaint:"Package stuck at Mumbai Hub for 3 days", Category:"Speed Post", Sentiment:"Negative", Priority:"High", Status:"Pending", Customer:"Ravi K."},
            {ID:"IP-1002", Complaint:"ATM card not received yet", Category:"Banking", Sentiment:"Neutral", Priority:"Medium", Status:"Resolved", Customer:"Sneha P."},
            {ID:"IP-1003", Complaint:"Staff was rude at Delhi GPO counter", Category:"Staff", Sentiment:"Negative", Priority:"High", Status:"Open", Customer:"Amit V."},
            {ID:"IP-1004", Complaint:"Tracking details not updating", Category:"General", Sentiment:"Neutral", Priority:"Low", Status:"Pending", Customer:"Priya S."},
            {ID:"IP-1005", Complaint:"Very fast delivery, thanks!", Category:"Speed Post", Sentiment:"Positive", Priority:"Low", Status:"Resolved", Customer:"Vikram R."}
        ];

        function switchView(viewId) {
            $('.nav-item').removeClass('active');
            $(`.nav-item[onclick*="${viewId}"]`).addClass('active');
            $('.app-view').removeClass('active');
            $(`#view-${viewId}`).addClass('active');
            $('#page-heading').text(viewId === 'dashboard' ? 'Dashboard Overview' : viewId.charAt(0).toUpperCase() + viewId.slice(1));
            if(viewId === 'dashboard' || viewId === 'complaints') fetchAllData();
            if(viewId === 'analytics') setTimeout(initAnalyticsCharts, 100);
        }

        // --- MODALS ---
        function openPendingModal() { document.getElementById('pendingModal').classList.add('open'); setTimeout(initPendingChart, 200); }
        function closePendingModal() { document.getElementById('pendingModal').classList.remove('open'); }
        
        function openTicketModal(id, msg, cat, sent, prio) {
            $('#tm-id').text(id); $('#tm-msg').text(msg); $('#tm-cat').text(cat); $('#tm-sent').text(sent); $('#tm-prio').text(prio);
            document.getElementById('ticketModal').classList.add('open');
        }
        function closeTicketModal() { document.getElementById('ticketModal').classList.remove('open'); }

        $(document).ready(function() {
            initVoice();
            initDashboardChart();
            renderTables(mockTickets);
            fetchAllData();
            setInterval(fetchAllData, 5000); 
        });

        function initVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const micBtn = document.getElementById('mic-trigger');
            const textArea = document.getElementById('manual-text');
            if (SpeechRecognition) {
                const recognition = new SpeechRecognition();
                recognition.continuous = false; recognition.lang = 'en-IN';
                micBtn.addEventListener('click', () => { micBtn.classList.toggle('active') ? recognition.start() : recognition.stop(); });
                recognition.onresult = (e) => { textArea.value += e.results[0][0].transcript; };
                recognition.onend = () => { micBtn.classList.remove('active'); };
            }
        }

        async function fetchAllData() {
            try {
                const res = await fetch(`${API_URL}/tickets`);
                const tickets = await res.json();
                if(tickets && tickets.length > 0) renderTables(tickets);
                const statsRes = await fetch(`${API_URL}/stats`);
                const stats = await statsRes.json();
                if(stats.kpi) {
                    $('#kpi-total').text(stats.kpi.total);
                    $('#kpi-resolved').text(stats.kpi.resolved);
                    $('#kpi-pending').text(stats.kpi.pending);
                }
            } catch (e) { console.log("Using Mock Data"); }
        }

        async function analyzeAndAdd() {
            const text = $('#manual-text').val();
            if(!text) return;
            try {
                const res = await fetch(`${API_URL}/analyze`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({text}) });
                const data = await res.json();
                $('#ai-output').show().text(`${data.Category} - ${data.Sentiment}`);
                $('#manual-text').val('');
                fetchAllData();
            } catch(e) { alert("Backend Error"); }
        }

        function renderTables(tickets) {
            const list = $('#sidebar-list'); list.empty();
            tickets.slice(0, 15).forEach(t => {
                let color = t.Priority === 'High' ? '#D32F2F' : '#388E3C';
                const safeMsg = t.Complaint.replace(/'/g, "\\'");
                list.append(`<div class="yt-row" onclick="openTicketModal('${t.ID}', '${safeMsg}', '${t.Category}', '${t.Sentiment}', '${t.Priority}')"><div class="priority-dot" style="background:${color}"></div><div>${t.Category}</div></div>`);
            });

            const tbody = $('#dashboard-table-body'); tbody.empty();
            tickets.slice(0, 5).forEach(t => {
                let badge = t.Priority === 'High' ? 'bg-red' : 'bg-green';
                tbody.append(`<tr><td>${t.ID}</td><td>${t.Complaint.substring(0,40)}...</td><td>${t.Category}</td><td>${t.Sentiment}</td><td><span class="badge ${badge}">${t.Priority}</span></td></tr>`);
            });

            const ftbody = $('#full-table-body'); ftbody.empty();
            tickets.forEach(t => ftbody.append(`<tr><td>${t.ID}</td><td>${t.Customer || 'Unknown'}</td><td>${t.Complaint}</td><td>${t.Category}</td><td>${t.Status}</td></tr>`));
        }

        function initDashboardChart() {
            const ctx = document.getElementById('dashboardChart').getContext('2d');
            dashboardChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: ['Speed Post', 'Banking', 'Staff', 'General'], datasets: [{ label: 'Volume', data: [12, 5, 3, 2], backgroundColor: '#CE2029', borderRadius: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        function initPendingChart() {
            if (pendingBarChart) return;
            const ctx = document.getElementById('pendingBarChart').getContext('2d');
            pendingBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Damaged/Lost', 'Delivery Delay', 'Financial', 'Fake', 'General', 'Staff', 'Others'],
                    datasets: [{ label: 'Pending', data: [412, 1205, 320, 89, 540, 210, 150], backgroundColor: ['#C62828', '#F57F17', '#1976D2', '#388E3C', '#777', '#E64A19', '#999'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function initAnalyticsCharts() {
            if(stackedBarChart) return;
            const ctxBar = document.getElementById('stackedBarChart').getContext('2d');
            stackedBarChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: ['Delayed', 'Lost', 'Staff', 'Speed Post', 'Tech'],
                    datasets: [
                        { label: 'Neg', data: [35, 30, 28, 42, 30], backgroundColor: '#C62828' },
                        { label: 'Neu', data: [40, 45, 35, 30, 35], backgroundColor: '#F57F17' },
                        { label: 'Pos', data: [25, 25, 37, 28, 35], backgroundColor: '#2E7D32' }
                    ]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } }
            });

            const ctxDonut = document.getElementById('donutChart').getContext('2d');
            donutChart = new Chart(ctxDonut, {
                type: 'doughnut',
                data: { labels: ['Neg', 'Neu', 'Pos'], datasets: [{ data: [65, 25, 10], backgroundColor: ['#C62828', '#F57F17', '#2E7D32'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });

            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(ctxTrend, {
                type: 'line',
                data: { labels: ['Jan','Feb','Mar','Apr','May'], datasets: [{ label: 'Inflow', data: [65, 59, 80, 81, 56], borderColor: '#CE2029', tension:0.4 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            var map = L.map('india-map', { zoomControl: false }).setView([22.5937, 78.9629], 4);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            L.circle([28.6139, 77.2090], { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: 50000 }).addTo(map);
            L.circle([19.0760, 72.8777], { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: 50000 }).addTo(map);
        }
    </script>
</body>
</html>
